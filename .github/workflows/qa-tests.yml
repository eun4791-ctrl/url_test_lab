name: QA Automation Tests - Updated

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL'
        required: true
        type: string
      tests:
        description: 'performance,responsive,tc,ux'
        required: true
        type: string

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Prepare directories
        run: mkdir -p reports screenshots videos qa-temp

      # ==================================================
      # ğŸ”¤ Install Korean Fonts
      # ==================================================
      - name: Install Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-nanum
          fc-cache -fv

      # ==================================================
      # Lighthouse
      # ==================================================
      - name: Lighthouse
        if: contains(github.event.inputs.tests, 'performance')
        run: |
          npm install -g lighthouse
          lighthouse "${{ github.event.inputs.target_url }}" \
            --output=json \
            --output-path=reports/lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" || true

      # ==================================================
      # Playwright install
      # ==================================================
      - name: Install Playwright (chromium only)
        if: contains(github.event.inputs.tests, 'responsive') || contains(github.event.inputs.tests, 'tc')
        run: |
          cd qa-temp
          npm init -y
          npm install playwright@1.42.1
          npx playwright install chromium

      # ==================================================
      # Responsive Screenshots
      # ==================================================
      - name: Responsive Screenshots
        if: contains(github.event.inputs.tests, 'responsive')
        run: |
          cat << 'EOF' > qa-temp/screenshot.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const url = '${{ github.event.inputs.target_url }}';
          const out = '../screenshots';
          fs.mkdirSync(out, { recursive: true });

          const browser = await chromium.launch({ headless: true });
          const page = await browser.newPage();

          await page.goto(url, { waitUntil: 'domcontentloaded' });
          await page.waitForTimeout(1500);

          for (const [name, w, h] of [
            ['desktop', 1920, 1080],
            ['tablet', 768, 1024],
            ['mobile', 375, 667]
          ]) {
            await page.setViewportSize({ width: w, height: h });
            await page.waitForTimeout(500);
            await page.screenshot({ path: `${out}/${name}.png` });
          }

          await browser.close();
          EOF

          cd qa-temp && node screenshot.mjs

      # ==================================================
      # UX Review
      # ==================================================
      - name: UX Review
        if: contains(github.event.inputs.tests, 'ux')
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          cat << EOF > reports/ux-review.json
          {
            "url": "${{ github.event.inputs.target_url }}",
            "timestamp": "$TIMESTAMP",
            "reviews": [
              {
                "priority": "ìƒ",
                "issue": "ì²« í™”ë©´ì—ì„œ ì£¼ìš” ê¸°ëŠ¥ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ",
                "cause": "CTA ê°€ì‹œì„±ì´ ë‚®ìŒ",
                "suggestion": "CTA ë²„íŠ¼ ê°•ì¡° ë° ìœ„ì¹˜ ê°œì„ "
              }
            ],
            "score": 7.3
          }
          EOF

      # ==================================================
      # Test Cases
      # ==================================================
      - name: Test Cases
        if: contains(github.event.inputs.tests, 'tc')
        run: |
          cat << 'EOF' > qa-temp/test.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';
          import fetch from 'node-fetch';

          const TARGET_URL = process.env.TARGET_URL || '';
          const videoDir = '../videos';
          fs.mkdirSync(videoDir, { recursive: true });

          /* -------------------------------
             Playwright ì‹¤í–‰
          -------------------------------- */
          const browser = await chromium.launch({ headless: true });
          const context = await browser.newContext({
            viewport: { width: 1280, height: 720 },
            recordVideo: { dir: videoDir }
          });
          const page = await context.newPage();

          const testCases = [];
          let passed = 0;
          let failed = 0;

          const safeTC = async (tc, fn) => {
            try {
              await fn();
              tc.result = 'passed';
              passed++;
            } catch (e) {
              tc.result = 'failed';
              tc.details = e.message;
              failed++;
            }
            testCases.push(tc);
          };

          const timestamp = new Date().toISOString();

          /* -------------------------------
             í…ŒìŠ¤íŠ¸ ì‹œì‘
          -------------------------------- */
          await page.goto(TARGET_URL, { waitUntil: 'domcontentloaded', timeout: 30000 });

          await safeTC(
            { id: 'TC-001', meta: { type: 'load' } },
            async () => {
              await page.title();
            }
          );

          await safeTC(
            { id: 'TC-002', meta: { type: 'scroll' } },
            async () => {
              await page.mouse.wheel(0, 1000);
            }
          );

          await safeTC(
            { id: 'TC-003', meta: { type: 'link-click' } },
            async () => {
              const links = page.locator('a:visible');
              if (await links.count() === 0) throw new Error('No visible links');
              await links.first().click({ force: true });
            }
          );

          await safeTC(
            { id: 'TC-004', meta: { type: 'button-exist' } },
            async () => {
              const buttons = page.locator('button:visible');
              if (await buttons.count() === 0) throw new Error('No visible buttons');
            }
          );

          await safeTC(
            { id: 'TC-005', meta: { type: 'input-fill' } },
            async () => {
              const inputs = page.locator('input:visible');
              if (await inputs.count() === 0) throw new Error('No visible inputs');
              await inputs.first().fill('QA Test');
            }
          );

          await safeTC(
            { id: 'TC-006', meta: { type: 'image-check' } },
            async () => {
              const imgs = page.locator('img');
              if (await imgs.count() === 0) throw new Error('No images found');
            }
          );

          await safeTC(
            { id: 'TC-007', meta: { type: 'heading-check' } },
            async () => {
              const heads = page.locator('h1,h2,h3');
              if (await heads.count() === 0) throw new Error('No headings');
            }
          );

          await safeTC(
            { id: 'TC-008', meta: { type: 'console-error' } },
            async () => {
              const errors = [];
              page.on('console', m => m.type() === 'error' && errors.push(m.text()));
              await page.waitForTimeout(500);
              if (errors.length > 0) throw new Error(errors.join(','));
            }
          );

          await safeTC(
            { id: 'TC-009', meta: { type: 'dom-stable' } },
            async () => {
              await page.waitForLoadState('networkidle', { timeout: 10000 });
            }
          );

          await safeTC(
            { id: 'TC-010', meta: { type: 'page-alive' } },
            async () => {
              await page.evaluate(() => document.body !== null);
            }
          );

          await context.close();
          await browser.close();

          /* -------------------------------
             AI ì„¤ëª… ìƒì„± (ì„ íƒ ë‹¨ê³„)
          -------------------------------- */
          async function enrichWithAI() {
            if (!process.env.OPENAI_API_KEY) return testCases;

            const prompt = `
          ë„ˆëŠ” QA ì—”ì§€ë‹ˆì–´ë‹¤.
          ì•„ë˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ì— ëŒ€í•´ ì„¤ëª… ë¬¸ì¥ë§Œ ìƒì„±í•˜ë¼.

          ê·œì¹™:
          - result ê°’ ë³€ê²½ ê¸ˆì§€
          - íŒì • ì´ìœ  ì¶”ì¸¡ ê¸ˆì§€
          - title, precondition, testStep, expectedResults, details ë§Œ ìƒì„±

          ì…ë ¥:
          ${JSON.stringify(testCases, null, 2)}

          JSONë§Œ ë°˜í™˜í•˜ë¼.
          `;

            const res = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${process.env.OPENAI_API_KEY}`
              },
              body: JSON.stringify({
                model: 'gpt-4o-mini',
                temperature: 0.2,
                messages: [{ role: 'user', content: prompt }]
              })
            });

            const data = await res.json();
            return JSON.parse(data.choices[0].message.content);
          }

          const finalCases = await enrichWithAI();

          /* -------------------------------
             ë¦¬í¬íŠ¸ ì €ì¥
          -------------------------------- */
          fs.writeFileSync(
            '../reports/tc-report.json',
            JSON.stringify(
              {
                url: TARGET_URL,
                timestamp,
                summary: {
                  total: finalCases.length,
                  passed,
                  failed,
                  successRate: Math.round((passed / finalCases.length) * 100)
                },
                testCases: finalCases
              },
              null,
              2
            )
          );
          EOF

          cd qa-temp && npm install playwright node-fetch && TARGET_URL="${{ github.event.inputs.target_url }}" node test.mjs

      # ==================================================
      # Artifacts
      # ==================================================
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: reports/lighthouse-report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: responsive-screenshots
          path: screenshots/

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ux-review
          path: reports/ux-review.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-video
          path: videos/

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-cases-report
          path: reports/tc-report.json
