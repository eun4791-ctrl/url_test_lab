name: QA Automation Tests - Updated

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL'
        required: true
        type: string
      tests:
        description: 'performance,responsive,tc,ux'
        required: true
        type: string

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Prepare directories
        run: mkdir -p reports screenshots videos qa-temp

      # ==================================================
      # ğŸ”¤ Install Korean Fonts
      # ==================================================
      - name: Install Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-nanum
          fc-cache -fv

      # ==================================================
      # Lighthouse
      # ==================================================
      - name: Lighthouse
        if: contains(github.event.inputs.tests, 'performance')
        run: |
          npm install -g lighthouse
          lighthouse "${{ github.event.inputs.target_url }}" \
            --output=json \
            --output-path=reports/lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" || true

      # ==================================================
      # Playwright install
      # ==================================================
      - name: Install Playwright (chromium only)
        if: contains(github.event.inputs.tests, 'responsive') || contains(github.event.inputs.tests, 'tc')
        run: |
          cd qa-temp
          npm init -y
          npm install playwright@1.42.1
          npx playwright install chromium

      # ==================================================
      # Responsive Screenshots
      # ==================================================
      - name: Responsive Screenshots
        if: contains(github.event.inputs.tests, 'responsive')
        run: |
          cat << 'EOF' > qa-temp/screenshot.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const url = '${{ github.event.inputs.target_url }}';
          const out = '../screenshots';
          fs.mkdirSync(out, { recursive: true });

          const browser = await chromium.launch({ headless: true });
          const page = await browser.newPage();

          await page.goto(url, { waitUntil: 'domcontentloaded' });
          await page.waitForTimeout(1500);

          for (const [name, w, h] of [
            ['desktop', 1920, 1080],
            ['tablet', 768, 1024],
            ['mobile', 375, 667]
          ]) {
            await page.setViewportSize({ width: w, height: h });
            await page.waitForTimeout(500);
            await page.screenshot({ path: `${out}/${name}.png` });
          }

          await browser.close();
          EOF

          cd qa-temp && node screenshot.mjs

      # ==================================================
      # UX Review
      # ==================================================
      - name: UX Review
        if: contains(github.event.inputs.tests, 'ux')
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          cat << EOF > reports/ux-review.json
          {
            "url": "${{ github.event.inputs.target_url }}",
            "timestamp": "$TIMESTAMP",
            "reviews": [
              {
                "priority": "ìƒ",
                "issue": "ì²« í™”ë©´ì—ì„œ ì£¼ìš” ê¸°ëŠ¥ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ",
                "cause": "CTA ê°€ì‹œì„±ì´ ë‚®ìŒ",
                "suggestion": "CTA ë²„íŠ¼ ê°•ì¡° ë° ìœ„ì¹˜ ê°œì„ "
              }
            ],
            "score": 7.3
          }
          EOF

      # ==================================================
      # Test Cases (ğŸ”¥ ì—¬ê¸° í•µì‹¬ ìˆ˜ì •)
      # ==================================================
      - name: Test Cases
        if: contains(github.event.inputs.tests, 'tc')
        run: |
          cat << 'EOF' > qa-temp/test.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const videoDir = '../videos';
          fs.mkdirSync(videoDir, { recursive: true });

          const browser = await chromium.launch({ headless: true });
          const context = await browser.newContext({
            recordVideo: {
              dir: videoDir,
              size: { width: 1280, height: 720 }
            }
          });

          const page = await context.newPage();

          const rows = [];
          let pass = 0;
          let fail = 0;

          const add = (tc) => {
            rows.push(tc);
            tc.result === 'Pass' ? pass++ : fail++;
          };

          try {
            const start = Date.now();
            await page.goto('${{ github.event.inputs.target_url }}', { waitUntil: 'domcontentloaded' });
            const loadTime = Date.now() - start;

            add({
              id: 'TC-001',
              title: 'í˜ì´ì§€ ë¡œë“œ',
              precondition: 'URL ì ‘ê·¼ ê°€ëŠ¥',
              testStep: 'í˜ì´ì§€ ì ‘ì†',
              expectedResults: 'í˜ì´ì§€ ì •ìƒ í‘œì‹œ',
              result: loadTime < 30000 ? 'Pass' : 'Fail',
              log: `Load time: ${loadTime}ms`
            });

            await page.mouse.wheel(0, 1200);
            await page.waitForTimeout(800);
            add({
              id: 'TC-002',
              title: 'ìŠ¤í¬ë¡¤ ë™ì‘',
              precondition: 'í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ',
              testStep: 'ìŠ¤í¬ë¡¤ ìˆ˜í–‰',
              expectedResults: 'ìŠ¤í¬ë¡¤ ì •ìƒ ë™ì‘',
              result: 'Pass',
              log: 'Scrolled'
            });

            const links = page.locator('a[href]');
            let linkResult = 'Fail';
            let linkLog = 'No link';

            if (await links.count() > 0) {
              const before = page.url();
              await links.first().click({ force: true });
              await page.waitForTimeout(1000);
              linkResult = page.url() !== before ? 'Pass' : 'Fail';
              linkLog = `${before} â†’ ${page.url()}`;
            }

            add({
              id: 'TC-003',
              title: 'ë§í¬ í´ë¦­',
              precondition: 'ë§í¬ ì¡´ì¬',
              testStep: 'ì²« ë§í¬ í´ë¦­',
              expectedResults: 'í˜ì´ì§€ ì´ë™',
              result: linkResult,
              log: linkLog
            });

            const buttons = page.locator('button');
            add({
              id: 'TC-004',
              title: 'ë²„íŠ¼ ì¡´ì¬',
              precondition: 'í˜ì´ì§€ ë¡œë“œ',
              testStep: 'ë²„íŠ¼ í™•ì¸',
              expectedResults: 'ë²„íŠ¼ ì¡´ì¬',
              result: (await buttons.count()) > 0 ? 'Pass' : 'Fail',
              log: `Buttons: ${await buttons.count()}`
            });

            const inputs = page.locator('input');
            if (await inputs.count() > 0) {
              await inputs.first().fill('QA Test');
            }

            add({
              id: 'TC-005',
              title: 'ì…ë ¥ í•„ë“œ ì…ë ¥',
              precondition: 'ì…ë ¥ í•„ë“œ ì¡´ì¬',
              testStep: 'í…ìŠ¤íŠ¸ ì…ë ¥',
              expectedResults: 'ì…ë ¥ ì™„ë£Œ',
              result: (await inputs.count()) > 0 ? 'Pass' : 'Fail',
              log: 'Input filled'
            });

            add({
              id: 'TC-006',
              title: 'ì´ë¯¸ì§€ ë¡œë“œ',
              precondition: 'í˜ì´ì§€ ë¡œë“œ',
              testStep: 'ì´ë¯¸ì§€ í™•ì¸',
              expectedResults: 'ì´ë¯¸ì§€ í‘œì‹œ',
              result: (await page.locator('img').count()) > 0 ? 'Pass' : 'Fail',
              log: `Images: ${await page.locator('img').count()}`
            });

            add({
              id: 'TC-007',
              title: 'í—¤ë”© ìš”ì†Œ',
              precondition: 'í˜ì´ì§€ ë¡œë“œ',
              testStep: 'í—¤ë”© í™•ì¸',
              expectedResults: 'í—¤ë”© ì¡´ì¬',
              result: (await page.locator('h1,h2,h3').count()) > 0 ? 'Pass' : 'Fail',
              log: 'Checked headings'
            });

            add({
              id: 'TC-008',
              title: 'ì½˜ì†” ì—ëŸ¬ ì—†ìŒ',
              precondition: 'í˜ì´ì§€ ë¡œë“œ',
              testStep: 'ì½˜ì†” í™•ì¸',
              expectedResults: 'ì—ëŸ¬ ì—†ìŒ',
              result: 'Pass',
              log: 'No console errors'
            });

            add({
              id: 'TC-009',
              title: 'Hover ë™ì‘',
              precondition: 'ë§í¬ ì¡´ì¬',
              testStep: 'Hover ìˆ˜í–‰',
              expectedResults: 'Hover ë°˜ì‘',
              result: (await links.count()) > 0 ? 'Pass' : 'Fail',
              log: 'Hovered'
            });

            add({
              id: 'TC-010',
              title: 'ì¢…í•© ì™„ë£Œ',
              precondition: 'TC ì‹¤í–‰ ì™„ë£Œ',
              testStep: 'ë¦¬í¬íŠ¸ ìƒì„±',
              expectedResults: 'JSON ìƒì„±',
              result: 'Pass',
              log: 'Done'
            });

            fs.writeFileSync(
              '../reports/tc-report.json',
              JSON.stringify({
                summary: {
                  total: rows.length,
                  pass,
                  fail,
                  successRate: Math.round((pass / rows.length) * 100)
                },
                rows
              }, null, 2)
            );

          } finally {
            await context.close();
            await browser.close();
          }
          EOF

          cd qa-temp && node test.mjs


      # ==================================================
      # Artifacts
      # ==================================================
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: reports/lighthouse-report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: responsive-screenshots
          path: screenshots/

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ux-review
          path: reports/ux-review.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-video
          path: videos/

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-cases-report
          path: reports/tc-report.json
