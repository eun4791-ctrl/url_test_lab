name: QA Automation Tests

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL'
        required: true
        type: string
      tests:
        description: 'performance,responsive,tc,ux'
        required: true
        type: string

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Prepare directories
        run: mkdir -p reports screenshots qa-temp

      # ==================================================
      # ğŸ”¤ Install Korean Fonts (í•œê¸€ ê¹¨ì§ ë°©ì§€)
      # ==================================================
      - name: Install Korean fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-nanum
          fc-cache -fv

      # ==================================================
      # Lighthouse
      # ==================================================
      - name: Lighthouse
        if: contains(github.event.inputs.tests, 'performance')
        run: |
          npm install -g lighthouse
          lighthouse "${{ github.event.inputs.target_url }}" \
            --output=json \
            --output-path=reports/lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" || true

      # ==================================================
      # Playwright ì„¤ì¹˜ (chromium only)
      # ==================================================
      - name: Install Playwright (chromium only)
        if: contains(github.event.inputs.tests, 'responsive') || contains(github.event.inputs.tests, 'tc')
        run: |
          cd qa-temp
          npm init -y
          npm install playwright@1.42.1
          npx playwright install chromium

      # ==================================================
      # Responsive Screenshots (í°íŠ¸ ë¡œë”© ëŒ€ê¸° í¬í•¨)
      # ==================================================
      - name: Responsive Screenshots
        if: contains(github.event.inputs.tests, 'responsive')
        run: |
          cat << 'EOF' > qa-temp/screenshot.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const url = '${{ github.event.inputs.target_url }}';
          const out = '../screenshots';
          fs.mkdirSync(out, { recursive: true });

          const browser = await chromium.launch({
            headless: true,
            args: ['--no-sandbox']
          });

          const page = await browser.newPage();

          // í˜ì´ì§€ ë¡œë”© + ì›¹í°íŠ¸ ë¡œë”© ì™„ë£Œ ëŒ€ê¸°
          await page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });
          await page.evaluate(() => document.fonts.ready);

          for (const [name, w, h] of [
            ['desktop', 1920, 1080],
            ['tablet', 768, 1024],
            ['mobile', 375, 667]
          ]) {
            await page.setViewportSize({ width: w, height: h });
            await page.waitForTimeout(500);
            await page.screenshot({ path: `${out}/${name}.png` });
          }

          await browser.close();
          EOF

          cd qa-temp && node screenshot.mjs

      # ==================================================
      # UX Review (JSON ê³ ì • í¬ë§·)
      # ==================================================
      - name: UX Review
        if: contains(github.event.inputs.tests, 'ux')
        run: |
          cat << 'EOF' > reports/ux-review.json
          {
            "url": "${{ github.event.inputs.target_url }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")",
            "reviews": [
              {
                "priority": "ìƒ",
                "issue": "ì²« í™”ë©´ì—ì„œ ì£¼ìš” ê¸°ëŠ¥ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ",
                "cause": "CTA ë²„íŠ¼ì˜ ê°€ì‹œì„±ì´ ë‚®ìŒ",
                "suggestion": "ì£¼ìš” CTA ë²„íŠ¼ì„ ë” í¬ê³  ëª…í™•í•˜ê²Œ ë°°ì¹˜"
              },
              {
                "priority": "ì¤‘",
                "issue": "ë¡œë”© ìƒíƒœ í‘œì‹œ ë¶€ì¡±",
                "cause": "ì‚¬ìš©ìê°€ ì§„í–‰ ìƒí™©ì„ ì•Œ ìˆ˜ ì—†ìŒ",
                "suggestion": "ë¡œë”© ì¸ë””ì¼€ì´í„° ë˜ëŠ” ë‹¨ê³„ í‘œì‹œ ì¶”ê°€"
              }
            ],
            "score": 7.3
          }
          EOF

      # ==================================================
      # Test Cases
      # ==================================================
      - name: Test Cases
        if: contains(github.event.inputs.tests, 'tc')
        run: |
          cat << 'EOF' > qa-temp/test.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const browser = await chromium.launch({ headless: true });
          const page = await browser.newPage();
          await page.goto('${{ github.event.inputs.target_url }}', { waitUntil: 'domcontentloaded' });

          const result = {
            title: await page.title(),
            buttons: await page.locator('button').count(),
            inputs: await page.locator('input').count(),
            links: await page.locator('a').count()
          };

          fs.writeFileSync('../reports/tc-report.json', JSON.stringify(result, null, 2));
          await browser.close();
          EOF

          cd qa-temp && node test.mjs

      # ==================================================
      # Artifacts (ë¶„ë¦¬ ì—…ë¡œë“œ)
      # ==================================================
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: reports/lighthouse-report.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: responsive-screenshots
          path: screenshots/

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ux-review
          path: reports/ux-review.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-cases-report
          path: reports/tc-report.json
