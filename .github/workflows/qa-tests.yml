name: QA Automation Tests
on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to test'
        required: true
        type: string
      tests:
        description: 'Comma-separated test types (performance,responsive,ux,tc)'
        required: true
        type: string

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Create reports directory
        run: mkdir -p reports screenshots

      # ========== Lighthouse Performance Test ==========
      - name: Install Lighthouse
        if: contains(github.event.inputs.tests, 'performance')
        run: npm install -g lighthouse

      - name: Run Lighthouse Performance Test
        if: contains(github.event.inputs.tests, 'performance')
        continue-on-error: true
        run: |
          lighthouse "${{ github.event.inputs.target_url }}" \
            --output=json \
            --output-path=./reports/lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" \
            --quiet || true
          
          lighthouse "${{ github.event.inputs.target_url }}" \
            --output=html \
            --output-path=./reports/lighthouse-report.html \
            --chrome-flags="--headless --no-sandbox" \
            --quiet || true
          
          echo "✅ Lighthouse test completed"

      # ========== Playwright Responsive Screenshots ==========
      - name: Install Playwright
        if: contains(github.event.inputs.tests, 'responsive')
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Generate Screenshots with Playwright
        if: contains(github.event.inputs.tests, 'responsive')
        continue-on-error: true
        run: |
          cat > screenshot.mjs << 'SCRIPT'
          import { chromium } from 'playwright';
          import fs from 'fs';
          import path from 'path';
          
          const screenshotsDir = './screenshots';
          if (!fs.existsSync(screenshotsDir)) {
            fs.mkdirSync(screenshotsDir, { recursive: true });
          }
          
          (async () => {
            try {
              const browser = await chromium.launch();
              const page = await browser.newPage();
              const targetUrl = '${{ github.event.inputs.target_url }}';
              
              console.log('Loading URL:', targetUrl);
              await page.goto(targetUrl, { waitUntil: 'networkidle', timeout: 30000 });
              
              // Desktop
              console.log('Capturing desktop screenshot...');
              await page.setViewportSize({ width: 1920, height: 1080 });
              await page.screenshot({ path: path.join(screenshotsDir, 'desktop.png') });
              
              // Tablet
              console.log('Capturing tablet screenshot...');
              await page.setViewportSize({ width: 768, height: 1024 });
              await page.screenshot({ path: path.join(screenshotsDir, 'tablet.png') });
              
              // Mobile
              console.log('Capturing mobile screenshot...');
              await page.setViewportSize({ width: 375, height: 667 });
              await page.screenshot({ path: path.join(screenshotsDir, 'mobile.png') });
              
              console.log('Screenshots captured successfully');
              await browser.close();
            } catch (error) {
              console.error('Screenshot error:', error);
              process.exit(1);
            }
          })();
          SCRIPT
          
          node screenshot.mjs

      # ========== AI UX Review with ChatGPT ==========
      - name: Install Playwright for UX Review
        if: contains(github.event.inputs.tests, 'ux')
        run: |
          npm install playwright
          npx playwright install chromium

      - name: Generate AI UX Review
        if: contains(github.event.inputs.tests, 'ux')
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > ux-review.mjs << 'SCRIPT'
          import { chromium } from 'playwright';
          import fs from 'fs';
          import https from 'https';
          
          const targetUrl = '${{ github.event.inputs.target_url }}';
          const apiKey = process.env.OPENAI_API_KEY;
          
          async function captureScreenshot() {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            
            console.log('Loading URL for UX review:', targetUrl);
            await page.goto(targetUrl, { waitUntil: 'networkidle', timeout: 30000 });
            await page.waitForTimeout(2000);
            
            await page.setViewportSize({ width: 1920, height: 1080 });
            const screenshotPath = 'ux-review-screenshot.png';
            await page.screenshot({ path: screenshotPath });
            console.log('UX review screenshot captured');
            
            await browser.close();
            return screenshotPath;
          }
          
          function callChatGPT(base64Image) {
            return new Promise((resolve, reject) => {
              const prompt = `당신은 UX 전문가입니다. 다음 웹사이트 스크린샷을 분석하고 UX 리뷰를 제공해주세요.

[리뷰 기준]
- "생각 안 하고 써도 되나?" 관점
- 사용 중 멈추거나 다시 생각하게 되는 순간

[리뷰 항목]
1. 첫 화면에서 이해되는 것 / 안 되는 것
2. 다음 행동이 자연스럽게 보이는가?
3. 용어, 버튼, 문구에서 헷갈리는 부분
4. 실수했을 때 UX(되돌리기, 안내, 피드백)
5. 사용자 기준 불편 포인트

[출력 형식]
정확히 5개의 리뷰를 다음 JSON 형식으로 반환해주세요:
{
  "reviews": [
    {
      "priority": "상/중/하",
      "issue": "사용자 시점의 문제점",
      "cause": "UX 이유",
      "suggestion": "디자인/문구/플로우 기준 개선 제안"
    }
  ]
}

반드시 유효한 JSON만 반환하세요.`;

              const requestData = JSON.stringify({
                model: 'gpt-4o',
                messages: [
                  {
                    role: 'user',
                    content: [
                      {
                        type: 'text',
                        text: prompt
                      },
                      {
                        type: 'image_url',
                        image_url: {
                          url: 'data:image/png;base64,' + base64Image,
                          detail: 'high'
                        }
                      }
                    ]
                  }
                ],
                max_tokens: 2000
              });
              
              const options = {
                hostname: 'api.openai.com',
                path: '/v1/chat/completions',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + apiKey,
                  'Content-Length': Buffer.byteLength(requestData)
                }
              };
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => { data += chunk; });
                res.on('end', () => {
                  try {
                    const response = JSON.parse(data);
                    if (response.error) {
                      console.error('OpenAI API Error:', response.error);
                      reject(response.error);
                    } else {
                      const content = response.choices[0].message.content;
                      const jsonMatch = content.match(/\{[\s\S]*\}/);
                      const result = jsonMatch ? JSON.parse(jsonMatch[0]) : { reviews: [] };
                      result.url = targetUrl;
                      result.timestamp = new Date().toISOString();
                      resolve(result);
                    }
                  } catch (e) {
                    console.error('Error parsing response:', e);
                    reject(e);
                  }
                });
              });
              
              req.on('error', (e) => {
                console.error('API Error:', e);
                reject(e);
              });
              
              req.write(requestData);
              req.end();
            });
          }
          
          async function main() {
            try {
              if (!fs.existsSync('reports')) {
                fs.mkdirSync('reports', { recursive: true });
              }
              
              if (!apiKey) {
                console.error('OPENAI_API_KEY not set');
                fs.writeFileSync('reports/ux-review.json', JSON.stringify({
                  url: targetUrl,
                  timestamp: new Date().toISOString(),
                  reviews: [],
                  error: 'OPENAI_API_KEY not set'
                }, null, 2));
                process.exit(1);
              }
              
              const screenshotPath = await captureScreenshot();
              const imageBuffer = fs.readFileSync(screenshotPath);
              const base64Image = imageBuffer.toString('base64');
              
              console.log('Calling ChatGPT API...');
              const result = await callChatGPT(base64Image);
              
              fs.writeFileSync('reports/ux-review.json', JSON.stringify(result, null, 2));
              console.log('UX Review saved successfully');
              
              fs.unlinkSync(screenshotPath);
            } catch (error) {
              console.error('UX review error:', error);
              fs.writeFileSync('reports/ux-review.json', JSON.stringify({
                url: targetUrl,
                timestamp: new Date().toISOString(),
                reviews: [],
                error: error.message
              }, null, 2));
              process.exit(1);
            }
          }
          
          main();
          SCRIPT
          
          node ux-review.mjs
          sleep 10

      # ========== Playwright Test Cases ==========
      - name: Generate and Run Test Cases
        if: contains(github.event.inputs.tests, 'tc')
        run: |
          npm install playwright
          npx playwright install chromium
          
          cat > test-cases.mjs << 'SCRIPT'
          import { chromium } from 'playwright';
          import fs from 'fs';
          
          const targetUrl = '${{ github.event.inputs.target_url }}';
          
          async function runTestCases() {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            
            console.log('Loading URL for test cases:', targetUrl);
            await page.goto(targetUrl, { waitUntil: 'networkidle', timeout: 30000 });
            
            const testCases = [];
            
            // 1. Page Load Test
            const pageTitle = await page.title();
            testCases.push({
              id: 'TC001',
              name: 'Page Load Test',
              status: pageTitle ? 'Pass' : 'Fail',
              details: 'Page title: ' + pageTitle
            });
            
            // 2. Links Availability Test
            const links = await page.locator('a').count();
            testCases.push({
              id: 'TC002',
              name: 'Links Availability Test',
              status: links > 0 ? 'Pass' : 'Fail',
              details: 'Found ' + links + ' links'
            });
            
            // 3. Images Load Test
            const images = await page.locator('img').count();
            testCases.push({
              id: 'TC003',
              name: 'Images Load Test',
              status: images > 0 ? 'Pass' : 'N/A',
              details: 'Found ' + images + ' images'
            });
            
            // 4. Form Elements Test
            const forms = await page.locator('form').count();
            const inputs = await page.locator('input').count();
            testCases.push({
              id: 'TC004',
              name: 'Form Elements Test',
              status: (forms > 0 || inputs > 0) ? 'Pass' : 'N/A',
              details: 'Forms: ' + forms + ', Inputs: ' + inputs
            });
            
            // 5. Button Elements Test
            const buttons = await page.locator('button').count();
            testCases.push({
              id: 'TC005',
              name: 'Button Elements Test',
              status: buttons > 0 ? 'Pass' : 'N/A',
              details: 'Found ' + buttons + ' buttons'
            });
            
            // 6. Heading Structure Test
            const h1 = await page.locator('h1').count();
            const h2 = await page.locator('h2').count();
            testCases.push({
              id: 'TC006',
              name: 'Heading Structure Test',
              status: (h1 > 0 || h2 > 0) ? 'Pass' : 'Fail',
              details: 'H1: ' + h1 + ', H2: ' + h2
            });
            
            // 7. Meta Tags Test
            const metaDesc = await page.locator('meta[name="description"]').count();
            testCases.push({
              id: 'TC007',
              name: 'Meta Tags Test',
              status: metaDesc > 0 ? 'Pass' : 'Fail',
              details: 'Meta description found: ' + (metaDesc > 0)
            });
            
            // 8. Responsive Design Test
            const viewport = page.viewportSize();
            testCases.push({
              id: 'TC008',
              name: 'Responsive Design Test',
              status: viewport ? 'Pass' : 'Fail',
              details: 'Viewport: ' + JSON.stringify(viewport)
            });
            
            // 9. Page Load Performance Test
            const navigationTiming = await page.evaluate(() => {
              const timing = window.performance.timing;
              return timing.loadEventEnd - timing.navigationStart;
            });
            testCases.push({
              id: 'TC009',
              name: 'Page Load Performance Test',
              status: navigationTiming < 5000 ? 'Pass' : 'Blocked',
              details: 'Load time: ' + navigationTiming + 'ms'
            });
            
            // 10. Accessibility Test
            const langAttr = await page.locator('html').getAttribute('lang');
            testCases.push({
              id: 'TC010',
              name: 'Accessibility Test',
              status: langAttr ? 'Pass' : 'Fail',
              details: 'Language attribute: ' + (langAttr || 'Not found')
            });
            
            await browser.close();
            return testCases;
          }
          
          async function main() {
            try {
              if (!fs.existsSync('reports')) {
                fs.mkdirSync('reports', { recursive: true });
              }
              
              const testCases = await runTestCases();
              
              const passed = testCases.filter(tc => tc.status === 'Pass').length;
              const failed = testCases.filter(tc => tc.status === 'Fail').length;
              const blocked = testCases.filter(tc => tc.status === 'Blocked').length;
              const na = testCases.filter(tc => tc.status === 'N/A').length;
              
              const result = {
                url: targetUrl,
                timestamp: new Date().toISOString(),
                testCases: testCases,
                summary: {
                  total: testCases.length,
                  passed: passed,
                  failed: failed,
                  blocked: blocked,
                  na: na,
                  success_rate: Math.round((passed / testCases.length) * 100)
                }
              };
              
              fs.writeFileSync('reports/test-cases.json', JSON.stringify(result, null, 2));
              console.log('Test cases completed:', JSON.stringify(result.summary));
            } catch (error) {
              console.error('Test cases error:', error);
              fs.writeFileSync('reports/test-cases.json', JSON.stringify({
                url: targetUrl,
                timestamp: new Date().toISOString(),
                testCases: [],
                error: error.message
              }, null, 2));
              process.exit(1);
            }
          }
          
          main();
          SCRIPT
          
          node test-cases.mjs

      # ========== Upload Artifacts ==========
      - name: Upload Lighthouse Report
        if: contains(github.event.inputs.tests, 'performance')
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: reports/lighthouse-report.json

      - name: Upload Screenshots
        if: contains(github.event.inputs.tests, 'responsive')
        uses: actions/upload-artifact@v3
        with:
          name: responsive-screenshots
          path: screenshots/

      - name: Upload UX Review
        if: contains(github.event.inputs.tests, 'ux')
        uses: actions/upload-artifact@v3
        with:
          name: ux-review
          path: reports/ux-review.json

      - name: Upload Test Cases
        if: contains(github.event.inputs.tests, 'tc')
        uses: actions/upload-artifact@v3
        with:
          name: test-cases
          path: reports/test-cases.json
