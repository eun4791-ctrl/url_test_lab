name: QA Automation Tests

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL to test'
        required: true
        type: string
      tests:
        description: 'Comma-separated test types (performance,responsive,ux,tc)'
        required: true
        type: string

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # ================== 기본 세팅 ==================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Prepare directories
        run: mkdir -p reports screenshots

      # ================== Lighthouse (Performance) ==================
      - name: Install Chrome
        if: contains(github.event.inputs.tests, 'performance')
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install Lighthouse
        if: contains(github.event.inputs.tests, 'performance')
        run: npm install -g lighthouse

      - name: Run Lighthouse
        if: contains(github.event.inputs.tests, 'performance')
        continue-on-error: true
        run: |
          lighthouse "${{ github.event.inputs.target_url }}" \
            --chrome-path=/usr/bin/google-chrome \
            --chrome-flags="--headless --no-sandbox" \
            --output=json \
            --output-path=reports/lighthouse.json || true

          lighthouse "${{ github.event.inputs.target_url }}" \
            --chrome-path=/usr/bin/google-chrome \
            --chrome-flags="--headless --no-sandbox" \
            --output=html \
            --output-path=reports/lighthouse.html || true

      # ================== Playwright (Responsive Screenshots) ==================
      - name: Install Playwright (Responsive)
        if: contains(github.event.inputs.tests, 'responsive')
        run: |
          npm install playwright@latest
          npx playwright install --with-deps chromium

      - name: Capture Screenshots
        if: contains(github.event.inputs.tests, 'responsive')
        continue-on-error: true
        run: |
          cat << 'EOF' > screenshot.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const url = '${{ github.event.inputs.target_url }}';
          const dir = 'screenshots';
          if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

          const run = async () => {
            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox']
            });
            const page = await browser.newPage();

            await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 30000 });

            const viewports = [
              { name: 'desktop', w: 1920, h: 1080 },
              { name: 'tablet', w: 768, h: 1024 },
              { name: 'mobile', w: 375, h: 667 }
            ];

            for (const v of viewports) {
              await page.setViewportSize({ width: v.w, height: v.h });
              await page.screenshot({ path: `${dir}/${v.name}.png` });
            }

            await browser.close();
          };

          run();
          EOF

          node screenshot.mjs

      # ================== UX Review (Mock) ==================
      - name: Generate UX Review
        if: contains(github.event.inputs.tests, 'ux')
        run: |
          cat << 'EOF' > ux-review.mjs
          import fs from 'fs';

          const report = {
            url: '${{ github.event.inputs.target_url }}',
            generatedAt: new Date().toISOString(),
            score: 7.4,
            issues: [
              { priority: '상', issue: 'CTA 가시성 부족', suggestion: '주요 버튼 강조' },
              { priority: '중', issue: '로딩 상태 미흡', suggestion: '로딩 UI 추가' },
              { priority: '하', issue: '모바일 버튼 작음', suggestion: '48px 이상 권장' }
            ]
          };

          fs.writeFileSync('reports/ux-review.json', JSON.stringify(report, null, 2));
          EOF

          node ux-review.mjs

      # ================== Test Cases ==================
      - name: Run Test Cases
        if: contains(github.event.inputs.tests, 'tc')
        run: |
          npm install playwright@latest
          npx playwright install --with-deps chromium

          cat << 'EOF' > test-cases.mjs
          import { chromium } from 'playwright';
          import fs from 'fs';

          const url = '${{ github.event.inputs.target_url }}';
          const results = [];

          const add = (id, title, pass, note = '') => {
            results.push({
              id,
              title,
              result: pass ? 'Pass' : 'Fail',
              note
            });
          };

          const run = async () => {
            const browser = await chromium.launch({
              headless: true,
              args: ['--no-sandbox']
            });
            const page = await browser.newPage();

            await page.goto(url, { waitUntil: 'domcontentloaded', timeout: 30000 });

            add('TC-01', '페이지 로드', !!(await page.title()));
            add('TC-02', '버튼 존재', (await page.locator('button').count()) > 0);
            add('TC-03', '이미지 존재', (await page.locator('img').count()) >= 0);
            add('TC-04', '링크 존재', (await page.locator('a').count()) > 0);

            await browser.close();

            fs.writeFileSync(
              'reports/tc-report.json',
              JSON.stringify({ url, results }, null, 2)
            );
          };

          run();
          EOF

          node test-cases.mjs

      # ================== Artifacts 분리 업로드 ==================
      - name: Upload Lighthouse Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: reports/lighthouse.*
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload Responsive Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: responsive-screenshots
          path: screenshots/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload UX Review
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ux-review
          path: reports/ux-review.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload Test Cases Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-cases-report
          path: reports/tc-report.json
          if-no-files-found: ignore
          retention-days: 7

      # ================== Summary ==================
      - name: Create Summary
        if: always()
        run: |
          echo "## ✅ QA Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "- URL: ${{ github.event.inputs.target_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ github.event.inputs.tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse / Screenshots / UX / TC 결과는 Artifacts 확인" >> $GITHUB_STEP_SUMMARY
