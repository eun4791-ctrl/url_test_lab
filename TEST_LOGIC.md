# AI 테스트 케이스 생성 및 실행 흐름 상세 분석

`scripts/test-cases.mjs` 파일의 내부 로직을 기반으로, AI가 어떻게 테스트 케이스를 설계하고 실행하는지 상세히 설명합니다.

## 1. 동작 흐름 (Workflow)

전체 과정은 크게 **4단계**로 나뉩니다.
1.  **컨텍스트 추출**: 현재 웹페이지의 DOM 구조를 읽어 AI가 이해하기 쉽게 압축합니다.
2.  **AI 생성 (Loop)**: 목표 개수(기본 10개)를 채울 때까지 반복해서 AI에게 테스트 시나리오를 요청합니다.
3.  **필터링 및 정제**: AI가 준 결과 중 중복이거나 질이 낮은 케이스를 걸러냅니다.
4.  **플레이북 실행**: 최종 확정된 시나리오대로 브라우저(Playwright)를 조작하여 테스트를 수행합니다.

---

## 2. 상세 메커니즘

### ① 페이지 컨텍스트 추출 (`extractPageContext`)
AI에게 HTML 전체를 던지면 토큰 비용이 너무 크기 때문에, **핵심 정보만 남기고 압축**합니다.
*   **제거 대상**: `<script>`, `<style>`, `<svg>`, 숨겨진 요소(`hidden`).
*   **속성 압축**: `id`, `class`, `name`, `data-testid` 등 테스트에 필요한 속성만 남기고 나머지는 제거합니다.
*   **텍스트 요약**: 너무 긴 텍스트는 50자로 자릅니다.
*   **Interactive 우선**: `<a>`, `<button>`, `<input>` 등 사용자와 상호작용하는 요소는 반드시 포함합니다.

### ② AI 프롬프트 및 생성 루프 (`generateTestCases`)
목표 개수(`TC_COUNT`)를 달성할 때까지 반복문(While Loop)을 돕니다.

*   **배치 사이즈 (Batch Size)**: 한 번의 API 요청에 **최대 30개**의 테스트 케이스 생성을 요청합니다.
*   **루프 제한**: 최대 **10번**까지 재시도합니다. (목표 개수를 못 채우더라도 무한 루프 방지)
*   **프롬프트 전략 (Role-Playing)**:
    *   **역할**: "당신은 시니어 QA 엔지니어입니다."
    *   **목표**: "Smoke Test 위주로, 동작 확인+결과 검증이 포함된 시나리오를 짜라."
    *   **금지 사항**: `:contains`, `xpath`, `video[playing]` 등 불안정한 셀렉터 사용 금지.
    *   **중복 방지**: 이미 생성된 시나리오의 제목 목록을 프롬프트에 포함시켜, "이것들과 겹치지 않는 것을 만들어라"고 지시합니다.

### ③ 필터링 로직 (`normalizeAndFilterTCs`)
AI가 생성한 결과라고 무조건 믿지 않고, 엄격한 규칙으로 검수합니다.

1.  **시그니쳐 중복 체크**: `Action + Selector` 조합이 동일하면 중복으로 간주하고 버립니다.
    *   예) "홈 로고 클릭" 시나리오가 이미 있는데, 제목만 바꿔서 똑같은 로고를 클릭하는 경우 제거.
2.  **유사도 체크**: 기존 테스트 케이스 제목과 텍스트 유사도가 60% 이상이면 중복으로 간주합니다.
3.  **검증 누락 제거**: `Click` 액션만 있고, 그 뒤에 `Check`(확인) 액션이 없으면 가치 없는 테스트로 판단하여 제거합니다.
4.  **금지된 셀렉터**: `:contains` 등이 포함되면 폐기합니다.

### ④ 실행 엔진 (`runPlaybookAction`)
확정된 JSON 시나리오를 Playwright 명령어로 변환하여 실행합니다.

*   **격리 실행 (Isolation)**: 각 테스트 케이스를 시작하기 전에 쿠키와 로컬 스토리지를 비워서, 서로 영향이 없도록 합니다.
*   **단계별 실행**:
    *   `check`: 요소가 화면에 보이는지 검증.
    *   `click`: 요소를 클릭 (빨간 테두리로 하이라이트 표시 후 클릭).
    *   `type`: 입력창에 텍스트 입력.
    *   `checkUrl`: URL이 변경되었는지 검증 (유연한 매칭 지원).
*   **결과 판정**:
    *   **Pass**: 모든 단계가 에러 없이 완료됨.
    *   **Fail**: 셀렉터를 못 찾거나(Selector), 값이 다르거나(Assertion), 이동하지 않음(Navigation).
    *   **N/A**: 시나리오 자체에 검증 단계가 없는 경우.

---

## 3. 요약 (Spec)

| 항목 | 설정값 | 설명 |
| :--- | :--- | :--- |
| **모델** | `gpt-4o-mini` | 빠르고 비용 효율적인 모델 사용 |
| **한 번에 요청 개수** | **30개** | 한 번 호출 시 최대 30개 시나리오 요청 |
| **최대 루프 횟수** | **10회** | 목표 개수 미달 시 최대 10번까지 재요청 |
| **타임아웃** | **5초** / **1분** | 요소 찾기 5초, 전체 페이지 로드 1분 |
| **재시도 전략** | **Temperature 증가** | 루프가 반복될수록 창의성(Temperature)을 0.1씩 높여서 새로운 시도 유도 |
